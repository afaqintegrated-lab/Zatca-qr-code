<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZATCA QR Code - Local Test Page</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .items-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #invoicePreview {
            display: none;
        }

        .invoice {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .invoice-header h1 {
            color: #667eea;
            font-size: 2.5em;
        }

        .qr-code-container {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .qr-code-container h4 {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .detail-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .detail-section p {
            margin: 5px 0;
            color: #555;
            line-height: 1.6;
        }

        .invoice-items {
            margin-bottom: 30px;
        }

        .invoice-items table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .invoice-items th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .invoice-items td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .invoice-items tr:hover {
            background: #f8f9fa;
        }

        .invoice-totals {
            display: flex;
            justify-content: flex-end;
        }

        .totals-table {
            width: 350px;
        }

        .totals-table tr {
            border-bottom: 1px solid #e0e0e0;
        }

        .totals-table td {
            padding: 10px;
        }

        .totals-table td:first-child {
            text-align: right;
            font-weight: 600;
            color: #666;
        }

        .totals-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: #333;
        }

        .totals-table tr.total-row {
            background: #667eea;
            color: white;
            font-size: 1.2em;
        }

        .totals-table tr.total-row td {
            color: white;
            font-weight: 700;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .action-buttons {
            margin-top: 20px;
            text-align: center;
        }

        .zatca-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .zatca-info h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .zatca-info ul {
            margin-left: 20px;
            color: #666;
        }

        .zatca-info li {
            margin: 5px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        strong {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🇸🇦 ZATCA QR Code Generator - Local Test</h1>
            <p>Create invoices with Saudi Arabia tax authority compliant QR codes</p>
        </div>

        <!-- Invoice Form -->
        <div id="invoiceForm" class="main-content">
            <div class="card">
                <h2>📋 Invoice Information</h2>
                
                <div class="form-group">
                    <label>Seller Name (Company Name) *</label>
                    <input type="text" id="sellerName" value="ABC Trading Company" required>
                </div>

                <div class="form-group">
                    <label>VAT Registration Number (15 digits) *</label>
                    <input type="text" id="vatNumber" value="123456789012345" maxlength="15" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Invoice Number *</label>
                        <input type="text" id="invoiceNumber" value="INV-2024-001" required>
                    </div>

                    <div class="form-group">
                        <label>Invoice Date *</label>
                        <input type="date" id="invoiceDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="customerName" value="XYZ Corporation" required>
                </div>

                <div class="form-group">
                    <label>Customer Address</label>
                    <textarea id="customerAddress">Riyadh, Saudi Arabia</textarea>
                </div>

                <div class="form-group">
                    <label>Customer VAT Number</label>
                    <input type="text" id="customerVat" value="987654321098765" maxlength="15">
                </div>

                <div class="zatca-info">
                    <h4>✅ ZATCA Phase 1 Requirements:</h4>
                    <ul>
                        <li>Seller name and VAT number are mandatory</li>
                        <li>Invoice date/time in ISO 8601 format</li>
                        <li>Total invoice amount including VAT</li>
                        <li>Total VAT amount</li>
                        <li>QR code with TLV (Tag-Length-Value) encoding</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>🛒 Invoice Items</h2>
                
                <div class="items-section">
                    <div id="itemsList">
                        <div class="item-row" data-item="1">
                            <div class="form-group">
                                <label>Item Description</label>
                                <input type="text" class="item-description" value="Professional Services" required>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" class="item-quantity" value="1" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Unit Price</label>
                                <input type="number" class="item-price" value="1000" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>VAT %</label>
                                <input type="number" class="item-vat" value="15" min="0" max="100" step="1" required>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-danger" onclick="removeItem(1)">✕</button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="addItem()">+ Add Item</button>
                </div>

                <div class="form-group">
                    <label>Notes / Terms & Conditions</label>
                    <textarea id="invoiceNotes" placeholder="Payment terms: 30 days net">Payment due within 30 days from invoice date.</textarea>
                </div>

                <button type="button" class="btn btn-primary" onclick="generateInvoice()">
                    🎯 Generate Invoice with ZATCA QR Code
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: white; font-weight: 600;">Generating ZATCA QR Code...</p>
        </div>

        <!-- Invoice Preview -->
        <div id="invoicePreview">
            <div class="alert alert-success">
                ✅ Invoice generated successfully! ZATCA Phase 1 compliant QR code has been added.
            </div>

            <div class="invoice">
                <div class="invoice-header">
                    <div>
                        <h1>INVOICE</h1>
                        <p style="font-size: 1.1em; color: #666; margin-top: 5px;" id="displayInvoiceNumber"></p>
                    </div>
                    <div class="qr-code-container">
                        <div id="qrcode"></div>
                        <h4>ZATCA QR Code</h4>
                        <p style="font-size: 0.8em; color: #999;">Scan with phone camera</p>
                    </div>
                </div>

                <div class="invoice-details">
                    <div class="detail-section">
                        <h3>From (Seller):</h3>
                        <p><strong id="displaySellerName"></strong></p>
                        <p>VAT Number: <span id="displaySellerVat"></span></p>
                    </div>
                    <div class="detail-section">
                        <h3>To (Customer):</h3>
                        <p><strong id="displayCustomerName"></strong></p>
                        <p id="displayCustomerAddress"></p>
                        <p id="displayCustomerVatSection"></p>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <p><strong>Invoice Date:</strong> <span id="displayInvoiceDate"></span></p>
                </div>

                <div class="invoice-items">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Invoice Items</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40%;">Description</th>
                                <th class="text-center" style="width: 10%;">Qty</th>
                                <th class="text-right" style="width: 15%;">Unit Price</th>
                                <th class="text-center" style="width: 10%;">VAT %</th>
                                <th class="text-right" style="width: 15%;">VAT Amount</th>
                                <th class="text-right" style="width: 15%;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="displayItems">
                        </tbody>
                    </table>
                </div>

                <div class="invoice-totals">
                    <table class="totals-table">
                        <tr>
                            <td>Subtotal (excl. VAT):</td>
                            <td id="displaySubtotal">0.00</td>
                        </tr>
                        <tr>
                            <td>Total VAT:</td>
                            <td id="displayTotalVat">0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td>TOTAL (incl. VAT):</td>
                            <td id="displayTotal">0.00</td>
                        </tr>
                    </table>
                </div>

                <div id="displayNotes" style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>

                <div class="zatca-info" style="margin-top: 30px;">
                    <h4>✅ ZATCA Phase 1 QR Code Information:</h4>
                    <ul>
                        <li><strong>Seller Name:</strong> <span id="qrSellerName"></span></li>
                        <li><strong>VAT Number:</strong> <span id="qrVatNumber"></span></li>
                        <li><strong>Date/Time:</strong> <span id="qrDateTime"></span></li>
                        <li><strong>Invoice Total:</strong> <span id="qrTotal"></span> SAR</li>
                        <li><strong>VAT Amount:</strong> <span id="qrVat"></span> SAR</li>
                        <li><strong>Encoding:</strong> TLV (Tag-Length-Value) Base64</li>
                    </ul>
                </div>
            </div>

            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="downloadPDF()">📥 Download as PDF</button>
                <button type="button" class="btn btn-secondary" onclick="createAnother()">📝 Create Another Invoice</button>
            </div>
        </div>
    </div>

    <script>
        // Set default date to today
        document.getElementById('invoiceDate').valueAsDate = new Date();

        let itemCounter = 1;

        // Add new item row
        function addItem() {
            itemCounter++;
            const itemsList = document.getElementById('itemsList');
            const newItem = document.createElement('div');
            newItem.className = 'item-row';
            newItem.setAttribute('data-item', itemCounter);
            newItem.innerHTML = `
                <div class="form-group">
                    <label>Item Description</label>
                    <input type="text" class="item-description" value="" required>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" class="item-quantity" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label>Unit Price</label>
                    <input type="number" class="item-price" value="0" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>VAT %</label>
                    <input type="number" class="item-vat" value="15" min="0" max="100" step="1" required>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger" onclick="removeItem(${itemCounter})">✕</button>
                </div>
            `;
            itemsList.appendChild(newItem);
        }

        // Remove item row
        function removeItem(itemId) {
            const items = document.querySelectorAll('.item-row');
            if (items.length > 1) {
                const item = document.querySelector(`[data-item="${itemId}"]`);
                if (item) item.remove();
            } else {
                alert('You must have at least one item!');
            }
        }

        // TLV Encoding Function (ZATCA Standard)
        function createTLV(tag, value) {
            const valueBytes = new TextEncoder().encode(value);
            const length = valueBytes.length;
            
            const tlv = new Uint8Array(2 + length);
            tlv[0] = tag;
            tlv[1] = length;
            tlv.set(valueBytes, 2);
            
            return tlv;
        }

        // Generate ZATCA Phase 1 QR Code
        function generateZATCAQR(data) {
            // Tag 1: Seller Name
            const tag1 = createTLV(1, data.sellerName);
            
            // Tag 2: VAT Registration Number
            const tag2 = createTLV(2, data.vatNumber);
            
            // Tag 3: Timestamp (ISO 8601 format)
            const timestamp = new Date(data.invoiceDate).toISOString();
            const tag3 = createTLV(3, timestamp);
            
            // Tag 4: Invoice Total (including VAT)
            const tag4 = createTLV(4, data.invoiceTotal.toFixed(2));
            
            // Tag 5: VAT Total
            const tag5 = createTLV(5, data.vatTotal.toFixed(2));
            
            // Combine all TLV structures
            const totalLength = tag1.length + tag2.length + tag3.length + tag4.length + tag5.length;
            const combined = new Uint8Array(totalLength);
            
            let offset = 0;
            combined.set(tag1, offset); offset += tag1.length;
            combined.set(tag2, offset); offset += tag2.length;
            combined.set(tag3, offset); offset += tag3.length;
            combined.set(tag4, offset); offset += tag4.length;
            combined.set(tag5, offset);
            
            // Convert to Base64
            let binary = '';
            for (let i = 0; i < combined.length; i++) {
                binary += String.fromCharCode(combined[i]);
            }
            const base64 = btoa(binary);
            
            return {
                base64: base64,
                timestamp: timestamp
            };
        }

        // Generate Invoice
        function generateInvoice() {
            // Validate form
            const sellerName = document.getElementById('sellerName').value.trim();
            const vatNumber = document.getElementById('vatNumber').value.trim();
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const customerName = document.getElementById('customerName').value.trim();

            if (!sellerName || !vatNumber || !invoiceNumber || !invoiceDate || !customerName) {
                alert('Please fill in all required fields marked with *');
                return;
            }

            if (vatNumber.length !== 15) {
                alert('VAT number must be exactly 15 digits');
                return;
            }

            // Show loading
            document.getElementById('loadingIndicator').classList.add('active');
            document.getElementById('invoiceForm').style.display = 'none';

            // Simulate processing delay
            setTimeout(() => {
                // Calculate totals
                const items = [];
                let subtotal = 0;
                let totalVat = 0;

                document.querySelectorAll('.item-row').forEach(row => {
                    const description = row.querySelector('.item-description').value;
                    const quantity = parseFloat(row.querySelector('.item-quantity').value);
                    const price = parseFloat(row.querySelector('.item-price').value);
                    const vatPercent = parseFloat(row.querySelector('.item-vat').value);

                    const lineTotal = quantity * price;
                    const lineVat = lineTotal * (vatPercent / 100);
                    const lineWithVat = lineTotal + lineVat;

                    items.push({
                        description,
                        quantity,
                        price,
                        vatPercent,
                        lineTotal,
                        lineVat,
                        lineWithVat
                    });

                    subtotal += lineTotal;
                    totalVat += lineVat;
                });

                const invoiceTotal = subtotal + totalVat;

                // Generate ZATCA QR Code
                const qrData = generateZATCAQR({
                    sellerName,
                    vatNumber,
                    invoiceDate,
                    invoiceTotal,
                    vatTotal: totalVat
                });

                // Display invoice
                displayInvoice({
                    sellerName,
                    vatNumber,
                    invoiceNumber,
                    invoiceDate,
                    customerName,
                    customerAddress: document.getElementById('customerAddress').value,
                    customerVat: document.getElementById('customerVat').value,
                    items,
                    subtotal,
                    totalVat,
                    invoiceTotal,
                    notes: document.getElementById('invoiceNotes').value,
                    qrData
                });

                // Hide loading
                document.getElementById('loadingIndicator').classList.remove('active');
                document.getElementById('invoicePreview').style.display = 'block';

                // Scroll to preview
                document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            }, 1500);
        }

        // Display Invoice
        function displayInvoice(data) {
            // Header
            document.getElementById('displayInvoiceNumber').textContent = data.invoiceNumber;
            document.getElementById('displaySellerName').textContent = data.sellerName;
            document.getElementById('displaySellerVat').textContent = data.vatNumber;
            document.getElementById('displayCustomerName').textContent = data.customerName;
            document.getElementById('displayCustomerAddress').textContent = data.customerAddress;
            
            if (data.customerVat) {
                document.getElementById('displayCustomerVatSection').textContent = 'VAT Number: ' + data.customerVat;
            } else {
                document.getElementById('displayCustomerVatSection').textContent = '';
            }

            document.getElementById('displayInvoiceDate').textContent = new Date(data.invoiceDate).toLocaleDateString('en-GB');

            // Items
            const itemsBody = document.getElementById('displayItems');
            itemsBody.innerHTML = '';
            
            data.items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-right">${item.price.toFixed(2)} SAR</td>
                    <td class="text-center">${item.vatPercent}%</td>
                    <td class="text-right">${item.lineVat.toFixed(2)} SAR</td>
                    <td class="text-right"><strong>${item.lineWithVat.toFixed(2)} SAR</strong></td>
                `;
                itemsBody.appendChild(row);
            });

            // Totals
            document.getElementById('displaySubtotal').textContent = data.subtotal.toFixed(2) + ' SAR';
            document.getElementById('displayTotalVat').textContent = data.totalVat.toFixed(2) + ' SAR';
            document.getElementById('displayTotal').textContent = data.invoiceTotal.toFixed(2) + ' SAR';

            // Notes
            if (data.notes) {
                document.getElementById('displayNotes').innerHTML = '<h4 style="color: #667eea; margin-bottom: 10px;">Notes:</h4><p>' + data.notes + '</p>';
            } else {
                document.getElementById('displayNotes').innerHTML = '';
            }

            // QR Code Info
            document.getElementById('qrSellerName').textContent = data.sellerName;
            document.getElementById('qrVatNumber').textContent = data.vatNumber;
            document.getElementById('qrDateTime').textContent = data.qrData.timestamp;
            document.getElementById('qrTotal').textContent = data.invoiceTotal.toFixed(2);
            document.getElementById('qrVat').textContent = data.totalVat.toFixed(2);

            // Generate QR Code Image
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear previous QR
            
            new QRCode(qrContainer, {
                text: data.qrData.base64,
                width: 150,
                height: 150,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });

            // Store data for PDF generation
            window.currentInvoiceData = data;
        }

        // Download as PDF
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const data = window.currentInvoiceData;
            
            // Title
            doc.setFontSize(24);
            doc.setTextColor(102, 126, 234);
            doc.text('INVOICE', 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(data.invoiceNumber, 20, 28);

            // QR Code
            const qrCanvas = document.querySelector('#qrcode canvas');
            if (qrCanvas) {
                const qrImage = qrCanvas.toDataURL('image/png');
                doc.addImage(qrImage, 'PNG', 160, 10, 35, 35);
                doc.setFontSize(8);
                doc.text('ZATCA QR Code', 167, 48);
            }

            // Seller Info
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('From (Seller):', 20, 60);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(data.sellerName, 20, 66);
            doc.text('VAT: ' + data.vatNumber, 20, 72);

            // Customer Info
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('To (Customer):', 120, 60);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(data.customerName, 120, 66);
            if (data.customerAddress) {
                doc.text(data.customerAddress, 120, 72);
            }

            // Invoice Date
            doc.setFontSize(10);
            doc.text('Invoice Date: ' + new Date(data.invoiceDate).toLocaleDateString('en-GB'), 20, 85);

            // Items Table
            let y = 100;
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Invoice Items', 20, y);
            
            y += 8;
            doc.setFillColor(102, 126, 234);
            doc.rect(20, y, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('Description', 22, y + 5);
            doc.text('Qty', 110, y + 5);
            doc.text('Price', 130, y + 5);
            doc.text('VAT%', 150, y + 5);
            doc.text('Total', 175, y + 5);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            data.items.forEach(item => {
                doc.text(item.description, 22, y);
                doc.text(item.quantity.toString(), 110, y);
                doc.text(item.price.toFixed(2), 130, y);
                doc.text(item.vatPercent + '%', 150, y);
                doc.text(item.lineWithVat.toFixed(2) + ' SAR', 175, y, { align: 'right' });
                y += 7;
            });

            // Totals
            y += 10;
            doc.setFont(undefined, 'bold');
            doc.text('Subtotal (excl. VAT):', 120, y);
            doc.text(data.subtotal.toFixed(2) + ' SAR', 185, y, { align: 'right' });
            
            y += 7;
            doc.text('Total VAT:', 120, y);
            doc.text(data.totalVat.toFixed(2) + ' SAR', 185, y, { align: 'right' });
            
            y += 10;
            doc.setFillColor(102, 126, 234);
            doc.rect(120, y - 5, 70, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('TOTAL (incl. VAT):', 122, y);
            doc.text(data.invoiceTotal.toFixed(2) + ' SAR', 185, y, { align: 'right' });

            // Notes
            if (data.notes) {
                y += 15;
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('Notes:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const splitNotes = doc.splitTextToSize(data.notes, 170);
                doc.text(splitNotes, 20, y + 5);
            }

            // Save PDF
            doc.save(data.invoiceNumber + '_ZATCA.pdf');
        }

        // Create Another Invoice
        function createAnother() {
            document.getElementById('invoicePreview').style.display = 'none';
            document.getElementById('invoiceForm').style.display = 'grid';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
